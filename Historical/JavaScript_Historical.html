<script>
  let historicalCollections = [];
  let currentHistoricalCollectionName = null;
  let currentHistPage = 1;
  const histPageSize = 100;
  let totalHistOrders = 0;
  let isLoadingHistoricalOrders = false;
  let isLoadingHistoricalInventory = false;
  
  // NEW state variables for filters and modal
  let fulfillmentStatusOptions = [];
  let orderIssueOptions = [];
  let uniqueOwnerNamesForFilter = [];
  let outfitOptionsForCollection = [];
  let currentlyEditingRow = null;
  let currentMissingLastNameFilterActive = false;

  function testPingServer() {
    google.script.run
      .withSuccessHandler(function(response) {
        google.script.run
          .withSuccessHandler(onInitialHistoricalDataLoaded)
          .withFailureHandler(onFailureHist_InitialData)
          .getInitialHistoricalAppData();
      })
      .withFailureHandler(function(error) {
        console.error("CLIENT JS: PING TEST - FAILED! Error:", JSON.stringify(error));
        let errorMsg = "Ping Test FAILED. Cannot contact server or 'testPing' is missing/erroring.";
        if(error && error.message) errorMsg += " Details: " + error.message;
        $('#messageAreaHist').empty().append(`<div class="alert alert-danger" role="alert">${errorMsg}</div>`);
        hideLoadingHist();
      })
      .testPing();
  }

  $(document).ready(function() {
    console.log("CLIENT JS: Document ready. Historical Viewer Initialized.");
    showLoadingHist('Initializing Connection...');
    testPingServer();

    $('#historicalCollectionSelect').on('change', function() {
      currentHistoricalCollectionName = $(this).val();
      currentHistPage = 1;
      totalHistOrders = 0;
      $('#historicalInventoryContent').data('loaded-for', '').empty();
      clearFilters(false);

      if (currentHistoricalCollectionName) {
        $('#historicalOrdersTitle span, #historicalInventoryTitle span').text(escapeHtml(currentHistoricalCollectionName));
        $('#viewHistoricalOrdersBtn, #viewHistoricalInventoryBtn, #downloadCsvBtnHist').prop('disabled', false);
        // Enable basic filters
        $('#filterOwnerSelectHist, #filterNameHist, #filterEmailHist, #filterStatusHist, #filterOrderIssueHist, #filterOmsCostHist, #filterStartDateHist, #filterEndDateHist, #stockFilterButtonGroupHist input, #filterMissingLastNameBtnHist, #applyFiltersBtnHist, #clearFiltersBtnHist').prop('disabled', false);
        $('#stockFilterButtonGroupHist label').removeClass('disabled');
        
        // --- MODIFICATION: Load stats and orders ---
        loadHistoricalStats(currentHistoricalCollectionName);
        switchToHistoricalView('orders');
      } else {
        $('#historicalDashboardStatsArea').hide(); // Hide stats if no collection is selected
        $('#historicalOrdersTableBody, #paginationControlsTopHist, #paginationControlsBottomHist, #historicalInventoryContent').empty();
        $('#historicalOrdersTitle span, #historicalInventoryTitle span').text('');
        $('#historicalOrdersArea, #historicalInventoryArea').hide();
        $('#viewHistoricalOrdersBtn, #viewHistoricalInventoryBtn, #downloadCsvBtnHist').prop('disabled', true);
        // Disable all filters
        $('#filterOwnerSelectHist, #filterNameHist, #filterEmailHist, #filterStatusHist, #filterOrderIssueHist, #filterOmsCostHist, #filterStartDateHist, #filterEndDateHist, #stockFilterButtonGroupHist input, #filterMissingLastNameBtnHist, #applyFiltersBtnHist, #clearFiltersBtnHist').prop('disabled', true);
        $('#stockFilterButtonGroupHist label').addClass('disabled');
      }
    });

    $('#viewHistoricalOrdersBtn').on('click', function() { if (currentHistoricalCollectionName) switchToHistoricalView('orders'); });
    $('#viewHistoricalInventoryBtn').on('click', function() { if (currentHistoricalCollectionName) switchToHistoricalView('inventory'); });

    $(document).on('click', '#paginationControlsTopHist .page-link, #paginationControlsBottomHist .page-link', function(e) {
        e.preventDefault();
        if ($(this).parent().hasClass('disabled') || $(this).parent().hasClass('active')) return;
        const newPage = parseInt($(this).data('page'));
        if (newPage && newPage !== currentHistPage) { currentHistPage = newPage; if (currentHistoricalCollectionName) loadHistoricalOrders(currentHistoricalCollectionName); }
    });
    
    // --- Filter Event Listeners ---
    $('#applyFiltersBtnHist').on('click', applyFiltersAndLoadHist);
    $('#clearFiltersBtnHist').on('click', function() { clearFilters(true); });
    $('#filterOwnerSelectHist, #filterStatusHist, #filterOrderIssueHist, #filterOmsCostHist, #filterStartDateHist, #filterEndDateHist').on('change', applyFiltersAndLoadHist);
    $('#filterNameHist, #filterEmailHist').on('keypress', function(e) { if (e.which === 13) { applyFiltersAndLoadHist(); } });
    $('input[name="stockFilterHist"]').on('change', applyFiltersAndLoadHist);
    $('#filterMissingLastNameBtnHist').on('click', function() {
        currentMissingLastNameFilterActive = !currentMissingLastNameFilterActive;
        $(this).toggleClass('active btn-success btn-orange');
        applyFiltersAndLoadHist();
    });
    
    // --- Modal Event Listeners ---
    $('#historicalOrdersTableBody').on('click', '.edit-order-btn', function() { handleEditOrderClick($(this)); });
    $('#saveOrderDetailsBtn').on('click', saveOrderDetails);
    $('#orderDetailsModal').on('hidden.bs.modal', function() {
        if (currentlyEditingRow) {
           currentlyEditingRow.removeClass('table-row-editing');
           currentlyEditingRow = null;
       }
    });
    $('#downloadCsvBtnHist').on('click', downloadHistoricalCsv);
  });

  // --- NEW: Function to load dashboard stats ---
  function loadHistoricalStats(collectionName) {
    if (!collectionName) {
        $('#historicalDashboardStatsArea').hide();
        return;
    }
    $('#historicalDashboardStatsArea').show();
    $('#historicalDashboardContent').html('<p class="text-center text-muted w-100"><i>Loading key metrics...</i></p>');
    google.script.run
        .withSuccessHandler(populateHistoricalDashboard)
        .withFailureHandler(onFailureHist)
        .getHistoricalDashboardStats(collectionName);
  }

  // --- NEW: Function to populate dashboard stats ---
  function populateHistoricalDashboard(stats) {
      const mainContent = $('#historicalDashboardContent');
      mainContent.empty();
      if (stats.error) {
          mainContent.html(`<p class="text-center text-danger w-100">Error loading metrics: ${escapeHtml(stats.error)}</p>`);
          return;
      }
      const total = stats.totalOrders || 0;
      const pending = stats.statusCounts['Pending'] || 0;
      const fulfilled = (stats.statusCounts['Fulfilled'] || 0) + (stats.statusCounts['Resolved'] || 0);

      mainContent.append(`
          <div class="col-md-4 mb-3">
              <div class="card text-center h-100"><div class="card-body d-flex flex-column justify-content-center">
                  <h3 class="card-title">${total}</h3><p class="card-text text-muted mb-0">Total Orders</p>
              </div></div>
          </div>
          <div class="col-md-4 mb-3">
              <div class="card text-center h-100"><div class="card-body d-flex flex-column justify-content-center">
                  <h3 class="card-title">${pending}</h3><p class="card-text text-muted mb-0">Pending</p>
              </div></div>
          </div>
          <div class="col-md-4 mb-3">
              <div class="card text-center h-100"><div class="card-body d-flex flex-column justify-content-center">
                  <h3 class="card-title">${fulfilled}</h3><p class="card-text text-muted mb-0">Fulfilled/Resolved</p>
              </div></div>
          </div>`);
  }

  function switchToHistoricalView(viewType) {
    currentHistoricalView = viewType;
    $('#historicalOrdersArea, #historicalInventoryArea').hide();
    $('#viewHistoricalOrdersBtn, #viewHistoricalInventoryBtn').removeClass('btn-info active').addClass('btn-secondary');

    if (viewType === 'orders') {
      $('#historicalOrdersArea').show();
      $('#viewHistoricalOrdersBtn').addClass('btn-info active');
      if (currentHistoricalCollectionName) loadHistoricalOrders(currentHistoricalCollectionName);
    } else if (viewType === 'inventory') {
      $('#historicalInventoryArea').show();
      $('#viewHistoricalInventoryBtn').addClass('btn-info active');
      if (currentHistoricalCollectionName) {
        if ($('#historicalInventoryContent').is(':empty') || $('#historicalInventoryContent').data('loaded-for') !== currentHistoricalCollectionName) {
            loadHistoricalInventory(currentHistoricalCollectionName);
        } else {
            checkAndHideLoading();
        }
      }
    }
  }

  function onInitialHistoricalDataLoaded(dataFromServer) {
    hideLoadingHist();
    if (dataFromServer && dataFromServer.error) {
      displayMessageHist(`Initialization Error: ${escapeHtml(dataFromServer.message || 'Unknown server error.')}`, 'danger');
    } else if (dataFromServer) {
        historicalCollections = dataFromServer.collections || [];
        fulfillmentStatusOptions = dataFromServer.statusOptions || [];
        orderIssueOptions = dataFromServer.issueOptions || [];
        
        if(historicalCollections.length === 0) displayMessageHist("No archived collections found.", "warning", 7000);
    } else {
        console.error("CLIENT JS: CRITICAL - Initial data format error. Raw data:", JSON.stringify(dataFromServer));
        displayMessageHist("Critical Warning: Could not load initial data (unexpected data format).", "danger", 0);
    }
    populateHistoricalCollectionSelector();
    populateFilterDropdowns(); // Populate new filter dropdowns
    populateModalDropdownOptions(); // Populate modal dropdowns
  }

  function onFailureHist_InitialData(error) {
    hideLoadingHist();
    console.error("CLIENT JS: onFailureHist_InitialData FIRING. Error:", JSON.stringify(error));
    let msg = "CRITICAL FAILURE: Could not load initial data.";
    if (error && error.message) msg += ` Server: ${error.message}`;
    displayMessageHist(msg, "danger", 0);
    historicalCollections = [];
    populateHistoricalCollectionSelector();
  }

  function populateHistoricalCollectionSelector() {
    const select = $('#historicalCollectionSelect');
    select.empty().append('<option value="" disabled selected>-- Select Archived Collection --</option>');
    if (historicalCollections && Array.isArray(historicalCollections) && historicalCollections.length > 0) {
      historicalCollections.forEach(function(c) {
        if (c && c.name) {
            select.append($('<option>', { value: String(c.name), text: String(c.name) }));
        }
      });
    } else { select.append('<option value="" disabled>No collections data.</option>'); }
  }
  
  function populateFilterDropdowns() {
    const statusFilter = $('#filterStatusHist');
    statusFilter.find('option:not([value=""])').remove(); 
    fulfillmentStatusOptions.forEach(opt => statusFilter.append($('<option>', { value: opt.value, text: opt.value })));
    
    const issueFilter = $('#filterOrderIssueHist');
    issueFilter.find('option:not([value=""])').remove();
    orderIssueOptions.forEach(opt => issueFilter.append($('<option>', { value: opt.value, text: opt.value })));
  }
  
  function populateModalDropdownOptions() {
    const statusSelect = $('#modalFulfillmentStatus'); statusSelect.empty();
    fulfillmentStatusOptions.forEach(opt => statusSelect.append($('<option>', { value: opt.value, text: opt.value })));

    const issueSelect = $('#modalOrderIssue'); issueSelect.empty();
    issueSelect.append($('<option>', { value: "", text: "-- None --" }));
    orderIssueOptions.forEach(opt => issueSelect.append($('<option>', { value: opt.value, text: opt.value })));
  }

  function loadHistoricalOrders(collectionName) {
    if (isLoadingHistoricalOrders || !collectionName) return;
    isLoadingHistoricalOrders = true;
    showLoadingHist(`Loading orders for ${escapeHtml(collectionName)} (Page ${currentHistPage})...`);
    $('#historicalOrdersTableBody').css('opacity', 0.5);
    $('#paginationControlsTopHist, #paginationControlsBottomHist').empty();
    const filters = getCurrentFilters();
    google.script.run.withSuccessHandler(onHistoricalOrdersLoaded).withFailureHandler(onHistoricalOrdersLoadFailure).getHistoricalFilteredOrders(collectionName, filters, currentHistPage, histPageSize);
  }
  
  function onHistoricalOrdersLoaded(result) {
    isLoadingHistoricalOrders = false;
    $('#historicalOrdersTableBody').css('opacity', 1);
    if (result.error) { 
      displayMessageHist(`Error loading orders: ${result.error}`, 'danger'); 
      $('#historicalOrdersTableBody').empty().html(`<tr><td colspan="8" class="text-danger text-center">Failed to load orders.</td></tr>`); 
      totalHistOrders = 0;
      $('#filterResultsMessageHist').text('Error loading orders.').addClass('text-danger'); 
    } else { 
      populateHistoricalOrdersTable(result.orders); 
      totalHistOrders = result.totalOrderCount; 
      currentHistPage = result.pageNumber; 
      if (totalHistOrders > 0) {
        $('#filterResultsMessageHist').text(`Found ${totalHistOrders} order(s).`).removeClass('text-danger');
      } else {
        $('#filterResultsMessageHist').text('No orders found.').addClass('text-danger');
      }
    }
    renderHistoricalPaginationControls(); 
    checkAndHideLoading();
  }

  function onHistoricalOrdersLoadFailure(error) {
    isLoadingHistoricalOrders = false; onFailureHist(error);
    $('#historicalOrdersTableBody').css('opacity', 1).empty().html(`<tr><td colspan="8" class="text-danger text-center">Server error (orders).</td></tr>`);
    totalHistOrders = 0; renderHistoricalPaginationControls(); checkAndHideLoading();
  }

  function populateHistoricalOrdersTable(orders) {
    const tableBody = $('#historicalOrdersTableBody'); 
    tableBody.empty();
    if (!orders || orders.length === 0) { 
      tableBody.append(`<tr><td colspan="8" class="text-center text-muted">No orders found for this page/collection: ${escapeHtml(currentHistoricalCollectionName || '')}.</td></tr>`); 
      return; 
    }
    orders.forEach(order => { 
        const contactName = order.contact || "";
        const nameParts = contactName.trim().split(/\s+/);
        const isMissingLastName = contactName.trim() !== "" && nameParts.length === 1;
        const missingLastNameClass = isMissingLastName ? 'missing-lastname-highlight' : '';
        const statusClass = 'status-' + (order.status || 'Unknown').replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '').toLowerCase(); 
        const dateOrderedDisplay = order.dateOrdered || '---';
        const outfitOrderedDisplay = order.outfitOrdered || '---';
        const omsIdDisplay = order.omsId || '---'; 
        const removedClass = order.status === 'Remove' ? 'status-removed-row' : '';
        const orderIdEsc = escapeHtml(order.orderId || '');

        const row = `
        <tr class="${removedClass} ${missingLastNameClass}" data-order-id="${orderIdEsc}">
            <td>${escapeHtml(order.contact || '')}</td>
            <td>${escapeHtml(order.email || '')}</td>
            <td>${escapeHtml(order.owner || '')}</td>
            <td><span class="badge ${statusClass}">${escapeHtml(order.status || 'N/A')}</span></td>
            <td>${escapeHtml(dateOrderedDisplay)}</td>
            <td>${escapeHtml(outfitOrderedDisplay)}</td>
            <td>${escapeHtml(omsIdDisplay)}</td>
            <td><button class="btn btn-sm btn-primary edit-order-btn" data-order-id="${orderIdEsc}" title="Edit Order"><i class="fas fa-edit"></i></button></td>
        </tr>`; 
        tableBody.append(row); 
    });
  }

  function renderHistoricalPaginationControls() {
      const paginationTop = $('#paginationControlsTopHist'); 
      const paginationBottom = $('#paginationControlsBottomHist'); 
      paginationTop.empty(); 
      paginationBottom.empty();
      if (!totalHistOrders || totalHistOrders <= histPageSize) { return; } 
      const totalPages = Math.ceil(totalHistOrders / histPageSize); 
      if (totalPages <= 1) return;
      let paginationHtml = '<nav aria-label="Historical Orders Navigation"><ul class="pagination pagination-sm justify-content-center">';
      paginationHtml += `<li class="page-item ${currentHistPage === 1 ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentHistPage - 1}" aria-label="Previous"><span aria-hidden="true">&laquo;</span></a></li>`;
      let startPage = Math.max(1, currentHistPage - 2); let endPage = Math.min(totalPages, currentHistPage + 2);
      if (currentHistPage <= 3) endPage = Math.min(totalPages, 5); if (currentHistPage > totalPages - 2) startPage = Math.max(1, totalPages - 4);
      if (startPage > 1) { paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`; if (startPage > 2) paginationHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`; }
      for (let i = startPage; i <= endPage; i++) { paginationHtml += `<li class="page-item ${i === currentHistPage ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`; }
      if (endPage < totalPages) { if (endPage < totalPages - 1) paginationHtml += `<li class="page-item disabled"><span class="page-link">...</span></li>`; paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`; }
      paginationHtml += `<li class="page-item ${currentHistPage === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${currentHistPage + 1}" aria-label="Next"><span aria-hidden="true">&raquo;</span></a></li>`;
      paginationHtml += '</ul></nav>'; 
      paginationTop.html(paginationHtml); 
      paginationBottom.html(paginationHtml);
  }

  function loadHistoricalInventory(collectionName) {
    if (isLoadingHistoricalInventory) return;
    isLoadingHistoricalInventory = true;
    showLoadingHist(`Loading inventory for ${escapeHtml(collectionName)}...`);
    $('#historicalInventoryContent').empty().html(`<div class="col-12 text-center"><i>Loading inventory...</i></div>`).data('loaded-for', '');
    google.script.run
      .withSuccessHandler(onHistoricalInventoryLoaded)
      .withFailureHandler(onHistoricalInventoryLoadFailure)
      .getHistoricalInventoryByCollection(collectionName);
  }
  
  // --- Functions for Modal and Editing (Copied & Adapted from Main JS) ---
  
  function handleEditOrderClick($button) {
      const orderId = $button.data('order-id');
      if (!orderId) return;

      currentlyEditingRow = $button.closest('tr');
      currentlyEditingRow.addClass('table-row-editing');
      
      $('#modalDuplicateWarning').hide();
      showLoadingHist('Loading order details...');
      google.script.run
          .withSuccessHandler(onHistoricalOrderDetailsLoaded)
          .withFailureHandler(onFailureHist)
          .getHistoricalOrderDetails(orderId);
  }

  function onHistoricalOrderDetailsLoaded(orderData) {
      hideLoadingHist();
      if (!orderData) { 
        displayMessageHist('Error: Could not load order details.', 'danger'); 
        if(currentlyEditingRow) currentlyEditingRow.removeClass('table-row-editing');
        return; 
      }
      
      console.log("Historical Order Details Loaded for Modal:", orderData);

      // --- Main form fields ---
      $('#modalOrderID').val(orderData.OrderID);
      $('#modalCollectionName').val(orderData.COLLECTION_NAME); 
      $('#modalContactName').text(escapeHtml(orderData.ContactNameForTitle || 'N/A'));

      const contactFullName = orderData.Contact || '';
      const firstSpaceIndex = contactFullName.indexOf(' ');
      let firstName = ''; let lastName = '';
      if (firstSpaceIndex === -1) { firstName = contactFullName; } else {
          firstName = contactFullName.substring(0, firstSpaceIndex);
          lastName = contactFullName.substring(firstSpaceIndex + 1);
      }
      $('#modalFirstName').val(firstName);
      $('#modalLastName').val(lastName);
      
      $('#modalEmail').val(orderData.Email || '');
      $('#modalOwner').val(orderData.Owner || '');
      $('#modalStreetAddress').val(orderData.StreetAddress || '');
      $('#modalCity').val(orderData.City || '');
      $('#modalStateAbbreviated').val(orderData.StateAbbreviated || '');
      $('#modalZipFormatted').val(orderData.ZipFormatted || '');
      
      // --- Notes fields ---
      $('#modalINSEAM').val(orderData.INSEAM || '');
      $('#modalNumOutfits').val(orderData.OutfitsRawOriginal || '');
      $('#modalGeneralNotes').val(orderData.GeneralNotes || '');
      $('#modalOutfitUnavailableNotes').val(orderData.OutfitUnavailableNotes || '');

      // --- Preferences List ---
      const prefsList = $('#modalPreferencesList'); prefsList.empty();
      if (orderData.preferenceStockStatus && orderData.preferenceStockStatus.length > 0) {
           orderData.preferenceStockStatus.forEach((prefInfo, index) => {
                const fileId = prefInfo.imageUrl;
                const imageContainerId = `pref-img-cont-hist-${index}-${Date.now()}`; 
                let imageHtml = `<div id="${imageContainerId}" class="pref-image-placeholder">[No Image]</div>`;

                if (fileId) {
                     imageHtml = `<div id="${imageContainerId}" class="pref-image-placeholder">[Loading...]</div>`;
                     google.script.run
                         .withSuccessHandler((imgData) => { 
                             if (imgData && imgData.base64) { 
                                 $(`#${imageContainerId}`).empty().html(`<img src="data:${imgData.mimeType};base64,${imgData.base64}" class="pref-image">`); 
                             } else { $(`#${imageContainerId}`).html('[No Image Data]'); } 
                         })
                         .withFailureHandler((err) => { $(`#${imageContainerId}`).html('[Image Fetch Error]'); })
                         .getImageData_Historical(fileId);
                }

                const stockClass = 'stock-' + (prefInfo.overallStatus || 'Unknown').replace(/\s+/g, '-').toLowerCase();
                let piecesHtml = '<div class="pref-stock-details">';
                if (prefInfo.pieceStatus && prefInfo.pieceStatus.length > 0) {
                     prefInfo.pieceStatus.forEach(p => { piecesHtml += `<div><strong>${escapeHtml(p.productName)}:</strong> <small>${escapeHtml(p.requiredSize)} &rarr; ${escapeHtml(p.status)}${escapeHtml(p.note)}</small></div>`; });
                } else piecesHtml += '<div class="text-muted">No piece details available.</div>';
                piecesHtml += '</div>';

                const outfitTitle = prefInfo.preference.replace(/\s*\(.*?\)$/, ''); 
                const itemHtml = `<div class="preference-item d-flex mb-3"><div class="mr-3" style="width: 80px; height: 100px;">${imageHtml}</div><div class="flex-grow-1"><h6><span class="pref-text">${index + 1}. ${escapeHtml(outfitTitle)}</span><span class="stock-status-badge ${stockClass}">${escapeHtml(prefInfo.overallStatus)}</span></h6>${piecesHtml}</div></div><hr class="my-2">`;
                prefsList.append(itemHtml);
           });
      } else { prefsList.append('<p class="text-muted">No outfit preferences listed for this order.</p>'); }

      // --- Order Placement fields ---
      $('#modalPromoCodeUsed').val(orderData.PromoCodeUsedDisplay || 'N/A'); 
      $('#modalDateOrderedDisplay').text(orderData.DateOrdered || '---'); 
      $('#modalDateOrdered').val(orderData.DateOrdered ? new Date(orderData.DateOrdered).toISOString() : '');
      $('#modalOMS_ID').val(orderData.OMS_ID || '');
      $('#modalOMS_Cost').val(orderData.OMS_Cost || '');
      $('#modalFulfillmentStatus').val(orderData.FulfillmentStatus || 'Pending');
      $('#modalOrderIssue').val(orderData.OrderIssue || '');
      
      // Populate "Outfit Ordered" dropdown
      google.script.run
        .withSuccessHandler(function(inventoryData) {
            const outfitSelect = $('#modalOutfitOrdered');
            outfitSelect.empty().append('<option value="">-- Select --</option><option value="N/A">N/A</option><option value="ALL">ALL</option>');
            if (inventoryData) {
                inventoryData.forEach(outfit => {
                    outfitSelect.append($('<option>', {value: outfit.name, text: outfit.name}));
                });
            }
            // Set the value after populating
            outfitSelect.val(orderData.OutfitOrdered || '');
        })
        .getHistoricalInventoryByCollection(orderData.COLLECTION_NAME);

      $('#orderDetailsModal').modal('show');
  }
  
  function saveOrderDetails() {
      $('#modalSpinner').show(); 
      $('#saveOrderDetailsBtn').prop('disabled', true);
      const formData = {};
      $('#orderDetailsForm').serializeArray().forEach(item => {
          formData[item.name] = item.value;
      });
       if (!formData.hasOwnProperty('Swap')) { formData.Swap = ""; }

      google.script.run
          .withSuccessHandler(onOrderSaveSuccess)
          .withFailureHandler(onFailureHist)
          .updateHistoricalOrder(formData);
  }

  function onOrderSaveSuccess(result) {
    $('#modalSpinner').hide(); 
    $('#saveOrderDetailsBtn').prop('disabled', false);
    if (result?.success) {
      $('#orderDetailsModal').modal('hide');
      displayMessageHist(result.message || 'Order updated!', 'success');
      loadHistoricalOrders(currentHistoricalCollectionName); // Reload current page
    } else {
      displayMessageHist(result.message || 'Failed to save order.', 'danger');
    }
  }

  // --- Filter Logic (Adapted from Main JS) ---
  function getCurrentFilters() {
    const filters = {};
    if ($('#filterOwnerSelectHist').val()) filters.owner = $('#filterOwnerSelectHist').val();
    if ($('#filterNameHist').val().trim()) filters.nameSearch = $('#filterNameHist').val().trim();
    if ($('#filterEmailHist').val().trim()) filters.emailSearch = $('#filterEmailHist').val().trim();
    if ($('#filterStatusHist').val()) filters.status = $('#filterStatusHist').val();
    if ($('#filterOrderIssueHist').val()) filters.orderIssue = $('#filterOrderIssueHist').val();
    if ($('#filterStartDateHist').val()) filters.dateRangeStart = $('#filterStartDateHist').val();
    if ($('#filterEndDateHist').val()) filters.dateRangeEnd = $('#filterEndDateHist').val();
    if ($('#filterOmsCostHist').val()) filters.omsCost = $('#filterOmsCostHist').val();
    filters.stockFilter = $('input[name="stockFilterHist"]:checked').val();
    if (currentMissingLastNameFilterActive) filters.missingLastName = true;
    return filters;
  }

  function clearFilters(triggerLoad = true) {
      $('#filterOwnerSelectHist, #filterNameHist, #filterEmailHist, #filterStatusHist, #filterOrderIssueHist, #filterStartDateHist, #filterEndDateHist, #filterOmsCostHist').val('');
      $('input[name="stockFilterHist"][value="all"]').prop('checked', true).parent().addClass('active').siblings().removeClass('active');
      currentMissingLastNameFilterActive = false;
      $('#filterMissingLastNameBtnHist').removeClass('active btn-success').addClass('btn-orange');
      $('#filterResultsMessageHist').text('');
      if (triggerLoad && currentHistoricalCollectionName) {
        applyFiltersAndLoadHist();
      }
  }

  function applyFiltersAndLoadHist() {
    currentHistPage = 1;
    loadHistoricalOrders(currentHistoricalCollectionName);
  }
  
  function downloadHistoricalCsv() {
        if (!currentHistoricalCollectionName) {
            displayMessageHist('Please select a collection to download its CSV.', 'warning'); 
            return;
        }
        showLoadingHist(`Generating CSV for ${escapeHtml(currentHistoricalCollectionName)}...`);
        const filters = getCurrentFilters();
        google.script.run
            .withSuccessHandler(onCsvDataReady)
            .withFailureHandler(onFailureHist)
            .generateHistoricalCsvData(currentHistoricalCollectionName, filters);
  }

  function onCsvDataReady(csvContent) { 
    hideLoadingHist(); 
    if (typeof csvContent !== 'string' || csvContent.startsWith("Error:") || csvContent.startsWith("No data")) { 
      displayMessageHist(csvContent || "CSV generation failed or no data to export.", 'warning'); 
      return; 
    } 
    try { 
      const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
      const link = document.createElement("a"); 
      const url = URL.createObjectURL(blob); 
      link.setAttribute("href", url); 
      const safeName = (currentHistoricalCollectionName || 'historical_export').replace(/[^a-z0-9]/gi, '_').toLowerCase(); 
      const stamp = new Date().toISOString().slice(0,10).replace(/-/g,''); 
      link.setAttribute("download", `historical_orders_${safeName}_${stamp}.csv`); 
      link.style.visibility = 'hidden'; 
      document.body.appendChild(link); 
      link.click(); 
      document.body.removeChild(link); 
      URL.revokeObjectURL(url); 
      displayMessageHist('CSV download prepared.', 'success'); 
    } catch (e) { 
      console.error("CSV Download error:", e); 
      displayMessageHist('CSV download failed on client side.', 'danger'); 
    } 
  }
  
  // --- The rest of the functions from the original file ---
  function onHistoricalInventoryLoaded(inventoryDataFromServer) {
    isLoadingHistoricalInventory = false;
    if (inventoryDataFromServer === null || !Array.isArray(inventoryDataFromServer)) {
        displayMessageHist('Failed to load inventory or data format is incorrect.', 'danger');
        $('#historicalInventoryContent').empty().html('<div class="col-12 text-center text-danger">Inventory data format error.</div>');
    } else {
      populateHistoricalInventory(inventoryDataFromServer);
      $('#historicalInventoryContent').data('loaded-for', currentHistoricalCollectionName);
    }
    checkAndHideLoading();
  }
  function onHistoricalInventoryLoadFailure(error) {
    isLoadingHistoricalInventory = false;
    onFailureHist(error);
    $('#historicalInventoryContent').empty().html('<div class="col-12 text-center text-danger">Server error loading inventory.</div>');
    checkAndHideLoading();
  }
  function populateHistoricalInventory(inventoryData) {
    const inventoryContent = $('#historicalInventoryContent');
    inventoryContent.empty();
    $('#historicalInventoryArea').show();
    if (!inventoryData || inventoryData.length === 0) {
      inventoryContent.append(`<div class="col-12"><p class="text-center text-muted my-4">No historical inventory found for collection: ${escapeHtml(currentHistoricalCollectionName || 'N/A')}.</p></div>`);
      return;
    }
    inventoryData.forEach((outfit, outfitIndex) => {
      if (!outfit || !outfit.name) {
          console.warn(`CLIENT: Skipping outfit at index ${outfitIndex} (missing name/object).`);
          return;
      }
      let piecesHtml = '';
      if (outfit.pieces && Array.isArray(outfit.pieces) && outfit.pieces.length > 0) {
        outfit.pieces.forEach((piece) => {
          if (!piece || !piece.productName) return;
          let sizesHtml = (piece.availableSizes && piece.availableSizes.length > 0) ? piece.availableSizes.map(s => `<span class="badge badge-pill badge-light mr-1">${escapeHtml(s)}</span>`).join(' ') : '<span class="text-muted font-italic">None</span>';
          piecesHtml += `<div class="piece-details mb-2"><strong>${escapeHtml(piece.productName)}</strong> <small>(${escapeHtml(piece.category || 'N/A')})</small><br><small class="text-muted">SKU: ${escapeHtml(piece.sku || 'N/A')}</small><br>Available: ${sizesHtml}</div>`;
        });
      } else { piecesHtml = '<p class="text-muted small">No pieces listed.</p>'; }
      
      let imageHtml; const fileId = outfit.imageUrl;
      const imageContainerId = `hist-inv-img-${String(outfit.name || 'unknown').replace(/[^a-zA-Z0-9]/g, "")}-${outfitIndex}`;
      if (fileId) {
        imageHtml = `<div id="${imageContainerId}" class="inventory-card-img-placeholder">[Loading Image...]</div>`;
        google.script.run
          .withSuccessHandler(function(imgData) {
            if (imgData && imgData.base64) {
              $(`#${imageContainerId}`).empty().append($('<img>').attr('src', `data:${imgData.mimeType};base64,${imgData.base64}`).css({width: '100%', height: '150px', objectFit: 'contain'}).attr('alt', escapeHtml(outfit.name)).on('error', function() { $(this).parent().text('[Img Load Err]'); }));
            } else { $(`#${imageContainerId}`).text('[No Img Data]'); }
          }).withFailureHandler(function(err) { $(`#${imageContainerId}`).text('[Img Fetch Err]'); }).getImageData_Historical(fileId);
      } else { imageHtml = '<div class="inventory-card-img-placeholder">[No Image]</div>'; }
      const inactiveIndicator = !outfit.isActive ? '<span class="badge badge-secondary ml-2 small">Inactive</span>' : '';
      const cardHtml = `<div class="col-md-6 col-lg-4 mb-3"><div class="card h-100">${imageHtml}<div class="card-body d-flex flex-column"><h5 class="card-title">${escapeHtml(outfit.name)} ${inactiveIndicator}</h5><h6 class="card-subtitle mb-2 text-muted small">Pieces:</h6><div style="flex-grow: 1;">${piecesHtml}</div></div></div></div>`;
      inventoryContent.append(cardHtml);
    });
  }

  function showLoadingHist(message = 'Loading...') { $('#loadingIndicatorHist p').text(message); $('#loadingIndicatorHist').show(); }
  function hideLoadingHist() { $('#loadingIndicatorHist').hide(); }
  function checkAndHideLoading() { if (!isLoadingHistoricalOrders && !isLoadingHistoricalInventory) { hideLoadingHist(); } }
  function displayMessageHist(message, type = 'info', duration = 5000) { const alertId = `alert-hist-${Date.now()}`; let alertClass = 'alert-info'; if (type === 'danger') alertClass = 'alert-danger'; else if (type === 'warning') alertClass = 'alert-warning'; else if (type === 'success') alertClass = 'alert-success'; let iconClass = 'fa-info-circle'; if (type === 'danger') iconClass = 'fa-exclamation-circle'; else if (type === 'warning') iconClass = 'fa-exclamation-triangle'; else if (type === 'success') iconClass = 'fa-check-circle'; const alertElement = $(`<div id="${alertId}" class="alert ${alertClass} alert-dismissible fade show" role="alert" style="margin-bottom: 5px;"><i class="fas ${iconClass} mr-2"></i> ${escapeHtml(message)}<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>`); $('#messageAreaHist').append(alertElement); if (duration > 0) { setTimeout(() => { $(`#${alertId}`).alert('close'); }, duration); } }
  function escapeHtml(unsafe) { if (unsafe === null || typeof unsafe === 'undefined') return ''; let text = unsafe.toString(); const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }; return text.replace(/[&<>"']/g, function(m) { return map[m]; }); }
  function onFailureHist(error) { isLoadingHistoricalOrders = false; isLoadingHistoricalInventory = false; checkAndHideLoading(); console.error('CLIENT JS: General onFailureHist. Error:', JSON.stringify(error)); let errorMessage = 'An unknown server error occurred.'; if (error && error.message) { errorMessage = error.message; } else if (typeof error === 'string') { errorMessage = error; } displayMessageHist(`Error: ${escapeHtml(errorMessage)}`, 'danger', 0); }
</script>
